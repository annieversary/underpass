<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <title>Underpass</title>

        <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css' />
        <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.13.4/codemirror.css'>
        <style>
            :root {
                --header-height: 4vh;
            }

            body { margin: 0; }

            #header {
                height: var(--header-height);
                width: 100%;
            }

            #run-button {
                font-size: 2rem;
                border-radius: 0;
                border: none;
                color: white;
                background-color: #48c774;
                cursor: pointer;
            }

            #container {
                display: flex;
                flex-direction: row;
                height: calc(100vh - var(--header-height));
            }

            #code-container {
                width: 40%;
                height: calc(100vh - var(--header-height));
            }

            #code-container > div {
                height: calc(100vh - var(--header-height));
            }

            #map {
                width: 60%;
                height: calc(100vh - var(--header-height));
            }
        </style>

        <script src='https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js'></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js" integrity="sha512-8RnEqURPUc5aqFEN04aQEiPlSAdE0jlFS/9iGgUyNtwFnSKCXhmB6ZTNl7LnDtDWKabJIASzXrzD0K+LYexU9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>
    <body>
        <div id="header">
            <button id="run-button">
                Run
            </button>
        </div>
        <div id="container">
            <div id="code-container">
            </div>
            <div id="map">

            </div>
        </div>

        <script>
            const map = new maplibregl.Map({
                container: 'map', // container id
                style: 'https://demotiles.maplibre.org/style.json', // style URL
                style: {
                    version: 8,
                    sources: {
                        'raster-tiles': {
                            type: 'raster',
                            tiles: [
                                'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
                            ],
                            tileSize: 256,
                            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        }
                    },
                    layers: [
                        {
                            id: 'simple-tiles',
                            type: 'raster',
                            source: 'raster-tiles',
                            minzoom: 0,
                            maxzoom: 22
                        }
                    ]
                },

                center: [-0.09, 51.505,],
                zoom: 10
            });

            var editor = CodeMirror(document.getElementById("code-container"), {
                styleActiveLine: true,
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                autoCloseTags: true,
                mode: "htmlmixed",
            });

            function mapBounds() {
                const b = map.getBounds();
                return {
                    ne: [b._ne.lat, b._ne.lng],
                    sw: [b._sw.lat, b._sw.lng],
                };
            }




            async function run() {
                const r = await fetch('/search', {
                    method: 'POST',
                    body: JSON.stringify({
                        query: editor.getValue(),
                        bbox: mapBounds(), // TODO get from leaflet
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                });
                const res = await r.json();

                new maplibregl.Marker().setLngLat(res.data.reverse()).addTo(map);
            }

            document.querySelector('#run-button').onclick = run;
        </script>
    </body>
</html>
